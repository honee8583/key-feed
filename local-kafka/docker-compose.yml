version: '3.8'

services:
  kafka:
    image: apache/kafka:latest
    container_name: local-kafka
    ports:
      - "9092:9092"
    environment:
      # KRaft 설정 (Zookeeper 없이 실행)
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      
      # [핵심 1] 리스너 설정 (내부용/외부용 분리)
      # CONTROLLER: 클러스터 내부 관리용 (9093)
      # PLAINTEXT: Docker 네트워크 내부 통신용 (kafka:29092) -> kafka-ui, MSA 서비스들이 사용
      # EXTERNAL: 호스트(내 컴퓨터) 외부 통신용 (localhost:9092) -> IntelliJ, 로컬 터미널이 사용
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 'CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT'
      KAFKA_LISTENERS: 'CONTROLLER://:9093,PLAINTEXT://:29092,EXTERNAL://:9092'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka:29092,EXTERNAL://localhost:9092'
      KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'
      
      # [핵심 2] 단일 브로커 환경을 위한 필수 설정 (Hang 방지)
      # 내부 토픽(__consumer_offsets)의 복제본을 1개로 설정 (기본값 3)
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      # 트랜잭션 상태 로그의 복제본을 1개로 설정 (기본값 3)
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      # 트랜잭션 처리를 위한 최소 동기화 복제본 개수 (ISR)를 1로 설정
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      
    networks:
      - kafka-net

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: local-kafka-ui
    ports:
      - "9090:8080"
    environment:
      - KAFKA_CLUSTERS_0_NAME=local-kafka
      # Docker 내부 네트워크이므로 내부 리스너 포트(29092) 사용
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:29092
    depends_on:
      - kafka
    networks:
      - kafka-net

networks:
  kafka-net:
    driver: bridge
