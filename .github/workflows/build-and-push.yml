name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      client-service: ${{ steps.filter.outputs.client-service }}
      identity-service: ${{ steps.filter.outputs.identity-service }}
      feed-service: ${{ steps.filter.outputs.feed-service }}
      crawl-service: ${{ steps.filter.outputs.crawl-service }}
      match-service: ${{ steps.filter.outputs.match-service }}
      notification-service: ${{ steps.filter.outputs.notification-service }}
      gateway: ${{ steps.filter.outputs.gateway }}
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸ” Detect changed services
        uses: dorny/paths-filter@v2
        id: filter
        with:
          base: ${{ github.event.before }}
          filters: |
            client-service:
              - 'client-service/**'
            identity-service:
              - 'identity-service/**'
            feed-service:
              - 'feed-service/**'
            crawl-service:
              - 'crawl-service/**'
            match-service:
              - 'match-service/**'
            notification-service:
              - 'notification-service/**'
            gateway:
              - 'gateway/**'
      
      - name: ğŸ“Š Show detection results
        run: |
          echo "=== ğŸ” Change Detection Results ==="
          echo "identity-service: ${{ steps.filter.outputs.identity-service }}"
          echo "feed-service: ${{ steps.filter.outputs.feed-service }}"
          echo "crawl-service: ${{ steps.filter.outputs.crawl-service }}"
          echo "match-service: ${{ steps.filter.outputs.match-service }}"
          echo "notification-service: ${{ steps.filter.outputs.notification-service }}"
          echo "gateway: ${{ steps.filter.outputs.gateway }}"
          echo "=================================="

  build-client-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.client-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸš€ Starting build
        run: echo "ğŸš€ Building client-service"

      - name: ğŸ”‘ Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./client-service
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/client-service:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/client-service:${{ github.sha }}

      - name: ğŸ“ Update Kubernetes manifest
        run: |
          git clone https://${{ secrets.GIT_TOKEN }}@github.com/${{ secrets.K8S_REPO }} k8s-repo
          cd k8s-repo
          # ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
          sed -i "s|image: .*/client-service:.*|image: ${{ secrets.DOCKERHUB_USERNAME }}/client-service:${{ github.sha }}|g" client-service/deployment.yaml
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add client-service/deployment.yaml
          git commit -m "ğŸš€ Update client-service to ${{ github.sha }}" || echo "No changes to commit"
          git push

      - name: âœ… Completed
        run: echo "âœ… client-service deployed"

  build-identity-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.identity-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸš€ Starting build for identity-service
        run: |
          echo "=================================="
          echo "ğŸš€ Building identity-service"
          echo "ğŸ“… Triggered at: $(date)"
          echo "ğŸ”– Commit SHA: ${{ github.sha }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "=================================="
      
      - name: â˜• Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ğŸ”¨ Build with Gradle
        working-directory: ./identity-service
        run: |
          chmod +x gradlew
          jwt_key=${{ secrets.JWT_KEY }} jasypt_key=${{ secrets.JASYPT_KEY }} ./gradlew clean build
      
      - name: ğŸ”‘ Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./identity-service
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/identity-service:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/identity-service:${{ github.sha }}
      
      - name: ğŸ“ Update Kubernetes manifest
        run: |
          echo "Cloning k8s manifests repository..."
          git clone https://${{ secrets.GIT_TOKEN }}@github.com/${{ secrets.K8S_REPO }} k8s-repo
          cd k8s-repo
          
          echo "Updating identity-service image tag..."
          sed -i "s|image: .*/identity-service:.*|image: ${{ secrets.DOCKERHUB_USERNAME }}/identity-service:${{ github.sha }}|g" identity-service/deployment.yaml
          
          echo "Committing changes..."
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add identity-service/deployment.yaml
          git commit -m "ğŸš€ Update identity-service to ${{ github.sha }}"
          git push
          
          echo "âœ… Manifest updated successfully!"
      
      - name: âœ… Build and deploy completed
        run: |
          echo "=================================="
          echo "âœ… identity-service build completed"
          echo "ğŸ³ Docker images:"
          echo "   - ${{ secrets.DOCKERHUB_USERNAME }}/identity-service:latest"
          echo "   - ${{ secrets.DOCKERHUB_USERNAME }}/identity-service:${{ github.sha }}"
          echo "ğŸ“ K8s manifest updated"
          echo "ğŸ”„ ArgoCD will sync automatically"
          echo "=================================="

  build-feed-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.feed-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸš€ Starting build
        run: echo "ğŸš€ Building feed-service"
      
      - name: â˜• Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ğŸ”¨ Build with Gradle
        working-directory: ./feed-service
        run: |
          chmod +x gradlew
          jwt_key=${{ secrets.JWT_KEY }} jasypt_key=${{ secrets.JASYPT_KEY }} ./gradlew clean build
      
      - name: ğŸ”‘ Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./feed-service
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/feed-service:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/feed-service:${{ github.sha }}
      
      - name: ğŸ“ Update Kubernetes manifest
        run: |
          git clone https://${{ secrets.GIT_TOKEN }}@github.com/${{ secrets.K8S_REPO }} k8s-repo
          cd k8s-repo
          sed -i "s|image: .*/feed-service:.*|image: ${{ secrets.DOCKERHUB_USERNAME }}/feed-service:${{ github.sha }}|g" feed-service/deployment.yaml
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add feed-service/deployment.yaml
          git commit -m "ğŸš€ Update feed-service to ${{ github.sha }}"
          git push
      
      - name: âœ… Completed
        run: echo "âœ… feed-service deployed"

  build-crawl-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.crawl-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸš€ Starting build
        run: echo "ğŸš€ Building crawl-service"
      
      - name: â˜• Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ğŸ”¨ Build with Gradle
        working-directory: ./crawl-service
        run: |
          chmod +x gradlew
          jwt_key=${{ secrets.JWT_KEY }} jasypt_key=${{ secrets.JASYPT_KEY }} ./gradlew clean build
      
      - name: ğŸ”‘ Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./crawl-service
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/crawl-service:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/crawl-service:${{ github.sha }}
      
      - name: ğŸ“ Update Kubernetes manifest
        run: |
          git clone https://${{ secrets.GIT_TOKEN }}@github.com/${{ secrets.K8S_REPO }} k8s-repo
          cd k8s-repo
          sed -i "s|image: .*/crawl-service:.*|image: ${{ secrets.DOCKERHUB_USERNAME }}/crawl-service:${{ github.sha }}|g" crawl-service/deployment.yaml
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add crawl-service/deployment.yaml
          git commit -m "ğŸš€ Update crawl-service to ${{ github.sha }}"
          git push
      
      - name: âœ… Completed
        run: echo "âœ… crawl-service deployed"

  build-match-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.match-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸš€ Starting build
        run: echo "ğŸš€ Building match-service"
      
      - name: â˜• Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ğŸ”¨ Build with Gradle
        working-directory: ./match-service
        run: |
          chmod +x gradlew
          jwt_key=${{ secrets.JWT_KEY }} jasypt_key=${{ secrets.JASYPT_KEY }} ./gradlew clean build
      
      - name: ğŸ”‘ Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./match-service
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/match-service:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/match-service:${{ github.sha }}
      
      - name: ğŸ“ Update Kubernetes manifest
        run: |
          git clone https://${{ secrets.GIT_TOKEN }}@github.com/${{ secrets.K8S_REPO }} k8s-repo
          cd k8s-repo
          sed -i "s|image: .*/match-service:.*|image: ${{ secrets.DOCKERHUB_USERNAME }}/match-service:${{ github.sha }}|g" match-service/deployment.yaml
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add match-service/deployment.yaml
          git commit -m "ğŸš€ Update match-service to ${{ github.sha }}"
          git push
      
      - name: âœ… Completed
        run: echo "âœ… match-service deployed"

  build-notification-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.notification-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸš€ Starting build
        run: echo "ğŸš€ Building notification-service"
      
      - name: â˜• Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ğŸ”¨ Build with Gradle
        working-directory: ./notification-service
        run: |
          chmod +x gradlew
          jwt_key=${{ secrets.JWT_KEY }} jasypt_key=${{ secrets.JASYPT_KEY }} ./gradlew clean build
      
      - name: ğŸ”‘ Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./notification-service
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/notification-service:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/notification-service:${{ github.sha }}
      
      - name: ğŸ“ Update Kubernetes manifest
        run: |
          git clone https://${{ secrets.GIT_TOKEN }}@github.com/${{ secrets.K8S_REPO }} k8s-repo
          cd k8s-repo
          sed -i "s|image: .*/notification-service:.*|image: ${{ secrets.DOCKERHUB_USERNAME }}/notification-service:${{ github.sha }}|g" notification-service/deployment.yaml
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add notification-service/deployment.yaml
          git commit -m "ğŸš€ Update notification-service to ${{ github.sha }}"
          git push
      
      - name: âœ… Completed
        run: echo "âœ… notification-service deployed"

  build-gateway:
    needs: detect-changes
    if: needs.detect-changes.outputs.gateway == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸš€ Starting build
        run: echo "ğŸš€ Building gateway"
      
      - name: â˜• Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ğŸ”¨ Build with Gradle
        working-directory: ./gateway
        run: |
          chmod +x gradlew
          jwt_key=${{ secrets.JWT_KEY }} jasypt_key=${{ secrets.JASYPT_KEY }} ./gradlew clean build
      
      - name: ğŸ”‘ Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./gateway
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/gateway:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/gateway:${{ github.sha }}
      
      - name: ğŸ“ Update Kubernetes manifest
        run: |
          git clone https://${{ secrets.GIT_TOKEN }}@github.com/${{ secrets.K8S_REPO }} k8s-repo
          cd k8s-repo
          sed -i "s|image: .*/gateway:.*|image: ${{ secrets.DOCKERHUB_USERNAME }}/gateway:${{ github.sha }}|g" gateway/deployment.yaml
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add gateway/deployment.yaml
          git commit -m "ğŸš€ Update gateway to ${{ github.sha }}"
          git push
      
      - name: âœ… Completed
        run: echo "âœ… gateway deployed"